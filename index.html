<!doctype html>
<html>
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Lokeshraj AI Tutor</title>
<style>
  body{font-family:system-ui,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0;padding:24px}
  .card{max-width:820px;margin:0 auto;background:#fff;border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.08);padding:20px}
  .row{display:flex;gap:8px;align-items:center}
  input[type="text"],textarea{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px}
  button{padding:12px 16px;border:0;border-radius:10px;background:#5a5cff;color:#fff}
  .answer{white-space:pre-wrap;background:#fafafa;border:1px solid #eee;border-radius:12px;padding:14px;margin-top:12px;min-height:48px}
  .controls{display:flex;flex-wrap:wrap;gap:8px;margin:8px 0}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#eef;border-radius:999px}
  .recents{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .recent{padding:6px 10px;background:#e7f7ff;border:1px solid #bde5ff;border-radius:999px;font-size:12px;cursor:pointer}
  .mt{margin-top:10px}
  .hidden{display:none}
</style>
</head>
<body>
<div class="card">
  <h2>Lokeshraj AI Tutor</h2>
  <div class="controls">
    <label class="chip"><input type="checkbox" id="speak" checked> Speak replies</label>
    <label class="chip">Voice
      <select id="voice">
        <option>Female</option><option>Male</option>
      </select>
    </label>
    <label class="chip">Rate <input id="rate" type="range" min="0.8" max="1.4" step="0.1" value="1"></label>
    <label class="chip">
      <input id="imgInput" type="file" accept="image/*" class="hidden">
      <span id="imgBtn" style="cursor:pointer;">+ Image</span>
    </label>
    <span id="imgName" class="chip hidden"></span>
  </div>

  <div class="row mt">
    <input id="q" type="text" placeholder="Ask anything…"/>
    <button id="askBtn">Ask</button>
  </div>

  <div id="ans" class="answer"></div>
  <div id="loading" class="mt hidden">Thinking… ⏳</div>

  <div class="mt"><strong>Recent searches</strong>
    <div id="recents" class="recents"></div>
  </div>
</div>

<script>
  // 1) PUT YOUR Apps Script Web App URL here:
  const API_BASE = "https://script.google.com/macros/s/AKfycbz4Ss9wGMiFXwOIG78arbZ0J0sp5QjN5Uf29OJo2L9Vh8pet0mSknoTEBX-s5BH-3Sc/exec"; // keep quotes

  // Welcome voice
  window.addEventListener('load', () => {
    try {
      const u = new SpeechSynthesisUtterance("Welcome to Lokeshraj AI Tutor! How can I help you today?");
      window.speechSynthesis.speak(u);
    } catch(e){}
    loadRecents();
  });

  const qEl = document.getElementById('q');
  const ansEl = document.getElementById('ans');
  const speakEl = document.getElementById('speak');
  const voiceEl = document.getElementById('voice');
  const rateEl = document.getElementById('rate');
  const askBtn = document.getElementById('askBtn');
  const loadingEl = document.getElementById('loading');

  const imgInput = document.getElementById('imgInput');
  const imgBtn = document.getElementById('imgBtn');
  const imgName = document.getElementById('imgName');
  let imgPayload = null;

  imgBtn.onclick = ()=> imgInput.click();
  imgInput.onchange = () => {
    const f = imgInput.files?.[0];
    if (!f) return;
    imgName.textContent = f.name;
    imgName.classList.remove('hidden');
    const reader = new FileReader();
    reader.onload = () => {
      const base64 = String(reader.result).split(',')[1]; // remove prefix
      imgPayload = { mime: f.type, data: base64 };
    };
    reader.readAsDataURL(f);
  };

  function pickVoice(gender){
    const list = window.speechSynthesis.getVoices();
    return list.find(v=>new RegExp(gender,'i').test(v.name)) || list[0] || null;
  }
  function speakText(text){
    if (!speakEl.checked || !text) return;
    const u = new SpeechSynthesisUtterance(text);
    const v = pickVoice(voiceEl.value);
    if (v) u.voice = v;
    u.rate = Number(rateEl.value||1);
    window.speechSynthesis.speak(u);
  }

  askBtn.onclick = async () => {
    const question = qEl.value.trim();
    if (!question && !imgPayload) return;
    ansEl.textContent = "";
    loadingEl.classList.remove('hidden');

    try {
      const body = { question };
      if (imgPayload) body.images = [imgPayload];

      const r = await fetch(API_BASE, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      const data = await r.json();
      const text = data.answer || data.error || "No response";
      ansEl.textContent = text;
      speakText(text);
      saveRecent(question);
    } catch (e) {
      ansEl.textContent = "Error: " + e;
    } finally {
      loadingEl.classList.add('hidden');
    }
  };

  // Recents (local)
  function saveRecent(q){
    if(!q) return;
    const list = JSON.parse(localStorage.getItem('recents')||"[]");
    list.unshift(q);
    localStorage.setItem('recents', JSON.stringify(Array.from(new Set(list)).slice(0,10)));
    loadRecents();
  }
  function loadRecents(){
    const list = JSON.parse(localStorage.getItem('recents')||"[]");
    const box = document.getElementById('recents');
    box.innerHTML = "";
    list.forEach(item=>{
      const b = document.createElement('span');
      b.className = 'recent';
      b.textContent = item;
      b.onclick = ()=>{ qEl.value = item; askBtn.click(); };
      box.appendChild(b);
    });
  }
</script>
</body>
</html>
